<?xml version="1.0" standalone="no"?>

<kickstart>


	<description>
	Your img-storage roll description here
	</description>

	<copyright>
	Copyright (c) 2000 - 2012 The Regents of the University of California.
	All rights reserved. Rocks(r) v5.5/v6.0 www.rocksclusters.org

	</copyright>

	<changelog>
	$Log$
	</changelog>

	<package>pika</package>
	<package>rabbitmq-server</package>
	<package>rocks-command-imgstorage</package>

<post>
/sbin/chkconfig rabbitmq-server on
/usr/lib/rabbitmq/bin/rabbitmq-plugins enable rabbitmq_management

# start the server and set up user credential
/sbin/service rabbitmq-server start
admin_pass=$(&lt; /dev/urandom tr -dc _A-Z-a-z-0-9 | head -c26)
/usr/sbin/rabbitmqctl add_user rocks ${admin_pass}
/usr/sbin/rabbitmqctl set_user_tags rocks administrator
/usr/sbin/rabbitmqctl set_permissions -p / rocks ".*" ".*" ".*"
echo "amqp://rocks:${admin_pass}@&Kickstart_PrivateHostname;:5672/%2F?connection_attempts=1000&amp;frame_max=64000&amp;heartbeat_interval=30" \
						&gt; /opt/rocks/etc/rabbitmq.conf
chmod 400 /opt/rocks/etc/rabbitmq.conf


echo "tank" &gt; /opt/rocks/etc/zfs_img.conf

# adding rabbitmq to 411 so we push the password to the nodes
echo "FILES_NOCOMMENT += /opt/rocks/etc/rabbitmq.conf" &gt;&gt; /var/411/Files.mk
echo "FILES_NOCOMMENT += /opt/rocks/etc/zfs_img.conf" &gt;&gt; /var/411/Files.mk
/usr/bin/make -C /var/411 411.mk

# setting default attribute to install daemon
# all vm-container run the vm daemon
/opt/rocks/bin/rocks set appliance attr vm-container img_storage_vm true
# all nas installs the nas daemon
/opt/rocks/bin/rocks set appliance attr nas img_storage_nas true

</post>

<post>
/opt/rocks/bin/rocks report databasesql img_manager | /opt/rocks/mysql/bin/mysql \
        --defaults-extra-file=/root/.rocks.my.cnf --user=root cluster &gt;\
                /tmp/kvm-database.log

</post>

</kickstart>
