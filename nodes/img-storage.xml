<?xml version="1.0" standalone="no"?>

<kickstart>


	<description>
	Your img-storage roll description here
	</description>

	<copyright>
	Copyright (c) 2000 - 2012 The Regents of the University of California.
	All rights reserved. Rocks(r) v5.5/v6.0 www.rocksclusters.org

	</copyright>

	<changelog>
	$Log$
	</changelog>

	<package>pika</package>
	<package>rocks-command-imgstorage</package>
	<package>roll-img-storage-usersguide</package>

<post>
admin_pass=$(&lt; /dev/urandom tr -dc _A-Z-a-z-0-9 | head -c26)
/usr/sbin/rabbitmqctl add_user img-storage ${admin_pass}
/usr/sbin/rabbitmqctl set_user_tags img-storage management
/usr/sbin/rabbitmqctl add_vhost img-storage
/usr/sbin/rabbitmqctl set_permissions -p img-storage img-storage ".*" ".*" ".*"
echo "${admin_pass}" &gt; /opt/rocks/etc/rabbitmq_img-storage.conf
chmod 400 /opt/rocks/etc/rabbitmq_img-storage.conf


# adding rabbitmq to 411 so we push the password to the nodes
echo "FILES_NOCOMMENT += /opt/rocks/etc/rabbitmq_img-storage.conf" &gt;&gt; /var/411/Files.mk
/usr/bin/make -C /var/411 411.mk

# setting default attribute to install daemon
# all vm-container run the vm daemon
/opt/rocks/bin/rocks set appliance attr vm-container img_storage_vm true
# all nas installs the nas daemon
/opt/rocks/bin/rocks set appliance attr nas img_storage_nas true
/opt/rocks/bin/rocks set appliance attr compute vm_container_zpool tank

/usr/sbin/adduser zfs -m
/opt/rocks/bin/rocks sync users
</post>

<post>
/opt/rocks/bin/rocks report databasesql img_manager | /opt/rocks/mysql/bin/mysql \
        --defaults-extra-file=/root/.rocks.my.cnf --user=root cluster &gt;\
                /tmp/kvm-database.log

</post>

</kickstart>
