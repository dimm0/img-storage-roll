<?xml version="1.0" standalone="no"?>

<kickstart>


	<description>
	Your img-storage roll description here
	</description>

	<copyright>
	Copyright (c) 2000 - 2012 The Regents of the University of California.
	All rights reserved. Rocks(r) v5.5/v6.0 www.rocksclusters.org

	</copyright>

	<changelog>
	$Log$
	</changelog>

	<package>foundation-sqlite</package>
	<package>foundation-pysqlite</package>
	<package>foundation-python-daemon</package>
	<package>foundation-python-lockfile</package>
	<package>img-storage-nas</package>
	<package cond="rocks_version_major == 6">scsi-target-utils</package>
	<package cond="rocks_version_major == 7">targetcli</package>
	<package>iscsi-initiator-utils</package>

<post cond="rocks_version_major == 6">
/sbin/chkconfig tgtd on
/sbin/chkconfig iscsid on
/sbin/chkconfig img-storage-nas on
</post>

<post cond="rocks_version_major == 7">
/usr/bin/systemctl enable target 
/usr/bin/systemctl enable iscsid 
/usr/bin/systemctl enable img-storage-nas
</post>

<post>
mkdir /var/log/rocks
<eval mode="xml">
/opt/rocks/bin/rocks report host imgstorage &hostname;
</eval>
<file name="/etc/rc.d/rocksconfig.d/post-99-restart-img-storage" perms="755">

#!/bin/bash
#
# while for the config file to be ready

while ! [ -f /opt/rocks/etc/rabbitmq.conf ] || ! [ -f /opt/rocks/etc/rabbitmq_img-storage.conf ] ; do
	sleep 1;
done

/sbin/service img-storage-nas start

# we need this only the first boot after the installation
# after that the file will be there
rm /etc/rc.d/rocksconfig.d/post-99-restart-img-storage
</file>

</post>

</kickstart>
